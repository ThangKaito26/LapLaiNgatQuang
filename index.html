<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quản lý Học Tập Lặp Lại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
            -webkit-tap-highlight-color: transparent;
        }
        .modal-backdrop, .confirm-backdrop, .timeline-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content, .confirm-content, .timeline-content, .single-task-timeline-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .toast {
            animation: slide-in 0.5s forwards, slide-out 0.5s 4.5s forwards;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        @keyframes slide-in {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        #timelineWrapper, #singleTaskTimelineContainer {
            scroll-behavior: smooth;
            scrollbar-width: none;
        }
        #timelineWrapper::-webkit-scrollbar, #singleTaskTimelineContainer::-webkit-scrollbar {
            display: none;
        }
        .timeline-day-column {
            flex: 0 0 250px;
        }
        .task-card {
             cursor: pointer;
             transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(71, 85, 105, 0.1), 0 4px 6px -2px rgba(71, 85, 105, 0.05);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Login Screen -->
    <div id="loginContainer" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="text-center p-8 bg-white rounded-xl shadow-2xl max-w-sm mx-auto border border-slate-200">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-indigo-600 mb-2">Lịch Trình Ôn Tập</h1>
            <p class="text-slate-500 mb-8">Đăng nhập để lưu trữ và đồng bộ tiến độ học tập.</p>
            <button id="loginBtn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-6 rounded-lg shadow-sm hover:bg-slate-50 transition-all transform hover:scale-105">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Đăng nhập với Google
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="container mx-auto p-4 md:p-6 max-w-6xl hidden">
        
        <header class="flex flex-wrap justify-between items-center mb-6 md:mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-indigo-600">Lịch Trình Ôn Tập</h1>
                <p class="text-slate-500 mt-2">Học thông minh hơn, không phải chăm chỉ hơn.</p>
            </div>
            <div class="flex items-center gap-4">
                 <div id="userInfo" class="text-right">
                    <p id="userName" class="font-semibold text-slate-700"></p>
                    <p id="userEmail" class="text-xs text-slate-500"></p>
                 </div>
                 <img id="userAvatar" class="w-12 h-12 rounded-full shadow-md border-2 border-white" src="" alt="User Avatar">
                 <button id="logoutBtn" title="Đăng xuất" class="p-3 rounded-full bg-white shadow-sm hover:bg-red-100 transition text-slate-600 hover:text-red-600">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
            <button id="addTaskBtn" class="w-full md:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                Thêm Chủ Đề Mới
            </button>
            <button id="timelineBtn" class="w-full md:w-auto flex items-center justify-center gap-2 bg-white text-indigo-600 border border-indigo-600 font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-50 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <i data-lucide="calendar-days" class="w-5 h-5"></i>
                Xem Timeline Chung
            </button>
        </div>

        <div class="mb-6 flex justify-center border-b border-slate-200">
            <button data-filter="all" class="filter-btn flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600">Tất Cả</button>
            <button data-filter="today" class="filter-btn flex-1 py-3 px-4 text-center font-medium text-slate-500">Cần Ôn Hôm Nay</button>
            <button data-filter="upcoming" class="filter-btn flex-1 py-3 px-4 text-center font-medium text-slate-500">Sắp Tới</button>
            <button data-filter="completed" class="filter-btn flex-1 py-3 px-4 text-center font-medium text-slate-500">Đã Hoàn Thành</button>
        </div>

        <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 md:gap-6"></div>
        <div id="loadingState" class="text-center py-10 text-slate-500"><p>Đang tải danh sách ôn tập...</p></div>
        <div id="emptyState" class="text-center py-20 px-6 bg-white rounded-lg shadow-sm hidden border border-slate-200">
             <i data-lucide="folder-open" class="w-16 h-16 mx-auto text-slate-300"></i>
            <h3 class="mt-4 text-lg font-medium text-slate-700">Chưa có chủ đề nào</h3>
            <p class="mt-1 text-sm text-slate-500">Nhấn "Thêm Chủ Đề Mới" để bắt đầu.</p>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="modalContent" class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-md p-6 md:p-8 transform scale-95 opacity-0">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-slate-800">Thêm Chủ Đề Mới</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="mb-4">
                    <label for="taskName" class="block text-sm font-medium text-slate-700 mb-1">Tên chủ đề</label>
                    <input type="text" id="taskName" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ví dụ: Từ vựng tiếng Anh Unit 5" required>
                </div>
                <div class="mb-6">
                    <label for="startDate" class="block text-sm font-medium text-slate-700 mb-1">Ngày bắt đầu học</label>
                    <input type="date" id="startDate" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition">Hủy</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Single Task Timeline Modal -->
    <div id="singleTaskTimelineModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div id="singleTaskTimelineContent" class="single-task-timeline-content bg-slate-50 rounded-lg shadow-2xl w-full max-w-md flex flex-col p-6 transform scale-95 opacity-0 h-[70vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-200 pb-4">
                <h2 id="singleTaskTimelineTitle" class="text-xl font-bold text-slate-800 truncate pr-4">Dòng thời gian</h2>
                <button id="closeSingleTaskTimelineBtn" class="p-2 rounded-full hover:bg-slate-200 text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="singleTaskTimelineContainer" class="flex-grow overflow-y-auto space-y-4 pr-2">
                <!-- Timeline steps will be injected here -->
            </div>
        </div>
    </div>

    <!-- General Timeline Modal -->
    <div id="timelineModal" class="timeline-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-40">
        <div class="timeline-content bg-white rounded-lg shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col p-6 transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 class="text-2xl font-bold text-slate-800">Dòng Thời Gian Ôn Tập Chung</h2>
                <div class="flex items-center gap-2">
                     <button id="timelinePrevBtn" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                     <button id="timelineNextBtn" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="arrow-right" class="w-6 h-6"></i></button>
                     <button id="closeTimelineBtn" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div id="timelineWrapper" class="flex-grow overflow-x-auto">
                <div id="timelineContainer" class="flex h-full gap-2 p-1"></div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-[60]">
        <div id="confirmContent" class="confirm-content bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 transform scale-95 opacity-0">
            <h3 id="confirmTitle" class="text-lg font-bold text-slate-900">Xác nhận hành động</h3>
            <p id="confirmMessage" class="text-sm text-slate-600 mt-2 mb-6">Bạn có chắc chắn muốn tiếp tục?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" class="px-5 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition">Hủy</button>
                <button id="confirmOkBtn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-xl hidden z-[70]">
        <p id="toastMessage"></p>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Dán thông tin cấu hình Firebase của bạn vào đây
        const firebaseConfig = {
            apiKey: "AIzaSyDiXkXsVuE_oFvCRjjx5HF-IRyvE0owEQE",
            authDomain: "laplaingatquang.firebaseapp.com",
            projectId: "laplaingatquang",
            storageBucket: "laplaingatquang.appspot.com",
            messagingSenderId: "824449193335",
            appId: "1:824449193335:web:80d2023aaa75dbb530fd72"
        };

        const appId = 'spaced-repetition-app-vietnamese';
        
        let app, auth, db, userId, topicsCollectionRef;
        let unsubscribe; 
        let localTopicsCache = [];

        const ui = {
            loginContainer: document.getElementById('loginContainer'),
            appContainer: document.getElementById('appContainer'),
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userInfo: {
                name: document.getElementById('userName'),
                email: document.getElementById('userEmail'),
                avatar: document.getElementById('userAvatar'),
            },
            taskList: document.getElementById('taskList'),
            addTaskBtn: document.getElementById('addTaskBtn'),
            taskModal: document.getElementById('taskModal'),
            modalContent: document.getElementById('modalContent'),
            modalTitle: document.getElementById('modalTitle'),
            taskForm: document.getElementById('taskForm'),
            cancelBtn: document.getElementById('cancelBtn'),
            taskIdInput: document.getElementById('taskId'),
            taskNameInput: document.getElementById('taskName'),
            startDateInput: document.getElementById('startDate'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            loadingState: document.getElementById('loadingState'),
            emptyState: document.getElementById('emptyState'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            timelineBtn: document.getElementById('timelineBtn'),
            timelineModal: {
                backdrop: document.getElementById('timelineModal'),
                content: document.querySelector('.timeline-content'),
                wrapper: document.getElementById('timelineWrapper'),
                container: document.getElementById('timelineContainer'),
                closeBtn: document.getElementById('closeTimelineBtn'),
                prevBtn: document.getElementById('timelinePrevBtn'),
                nextBtn: document.getElementById('timelineNextBtn'),
            },
            singleTaskTimelineModal: {
                backdrop: document.getElementById('singleTaskTimelineModal'),
                content: document.getElementById('singleTaskTimelineContent'),
                title: document.getElementById('singleTaskTimelineTitle'),
                container: document.getElementById('singleTaskTimelineContainer'),
                closeBtn: document.getElementById('closeSingleTaskTimelineBtn'),
            },
            confirmModal: {
                backdrop: document.getElementById('confirmModal'),
                content: document.getElementById('confirmContent'),
                title: document.getElementById('confirmTitle'),
                message: document.getElementById('confirmMessage'),
                okBtn: document.getElementById('confirmOkBtn'),
                cancelBtn: document.getElementById('confirmCancelBtn'),
            }
        };

        const repetitionIntervals = [1, 3, 7, 15, 30];
        const getReviewSchedule = (startDateStr) => repetitionIntervals.map(days => {
            let reviewDate = new Date(startDateStr + 'T00:00:00');
            reviewDate.setDate(reviewDate.getDate() + days);
            return reviewDate;
        });
        const formatDate = (date) => date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const formatDayOfWeek = (date) => date.toLocaleDateString('vi-VN', { weekday: 'long' });
        const isToday = (date) => new Date().toDateString() === date.toDateString();
        const isPast = (date) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            return date < today;
        }

        function showToast(message) {
            ui.toastMessage.textContent = message;
            ui.toast.classList.remove('hidden');
            setTimeout(() => ui.toast.classList.add('hidden'), 5000);
        }
        
        function showCustomConfirm({ title, message, okText = 'OK', onOk }) {
            ui.confirmModal.title.textContent = title;
            ui.confirmModal.message.textContent = message;
            ui.confirmModal.okBtn.textContent = okText;
            ui.confirmModal.backdrop.classList.remove('hidden');
            setTimeout(() => {
                ui.confirmModal.backdrop.classList.remove('opacity-0');
                ui.confirmModal.content.classList.remove('scale-95', 'opacity-0');
            }, 10);
            const hide = () => {
                ui.confirmModal.backdrop.classList.add('opacity-0');
                ui.confirmModal.content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => ui.confirmModal.backdrop.classList.add('hidden'), 300);
            };
            const okListener = () => { onOk(); hide(); };
            const cancelListener = () => hide();
            ui.confirmModal.okBtn.addEventListener('click', okListener, { once: true });
            ui.confirmModal.cancelBtn.addEventListener('click', cancelListener, { once: true });
        }

        function renderTasks(filter = 'all') {
            ui.loadingState.style.display = 'none';
            let filteredTopics = localTopicsCache;
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            if (filter === 'today') {
                filteredTopics = localTopicsCache.filter(task => getNextReviewInfo(task) && isToday(getNextReviewInfo(task).date));
            } else if (filter === 'upcoming') {
                filteredTopics = localTopicsCache.filter(task => {
                    const nextReview = getNextReviewInfo(task);
                    return nextReview && !isToday(nextReview.date) && nextReview.date > now;
                });
            } else if (filter === 'completed') {
                filteredTopics = localTopicsCache.filter(task => !getNextReviewInfo(task));
            }

            ui.taskList.innerHTML = '';
            if (filteredTopics.length === 0 && localTopicsCache.length > 0) {
                ui.emptyState.classList.remove('hidden');
                ui.emptyState.querySelector('h3').textContent = `Không có chủ đề nào trong mục này`;
            } else if (localTopicsCache.length === 0) {
                 ui.emptyState.classList.remove('hidden');
                 ui.emptyState.querySelector('h3').textContent = `Chưa có chủ đề nào`;
            } else {
                ui.emptyState.classList.add('hidden');
            }

            filteredTopics.sort((a, b) => {
                const nextA = getNextReviewInfo(a)?.date || new Date('9999-12-31');
                const nextB = getNextReviewInfo(b)?.date || new Date('9999-12-31');
                return nextA - nextB;
            });

            filteredTopics.forEach(task => ui.taskList.appendChild(createTaskCard(task)));
            lucide.createIcons();
        }

        function getNextReviewInfo(task) {
            const schedule = getReviewSchedule(task.startDate);
            const reviewsCompleted = task.reviewsCompleted || 0;
            if (reviewsCompleted >= schedule.length) return null;
            return { date: schedule[reviewsCompleted], index: reviewsCompleted };
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card bg-white rounded-lg shadow-md p-5 flex flex-col border-l-4';
            card.dataset.id = task.id;

            const reviewsCompleted = task.reviewsCompleted || 0;
            const totalReviews = repetitionIntervals.length;
            const progressPercent = totalReviews > 0 ? (reviewsCompleted / totalReviews) * 100 : 0;
            const nextReview = getNextReviewInfo(task);
            let statusText, statusColor, borderColor;

            if (nextReview) {
                const today = new Date(); today.setHours(0,0,0,0);
                const reviewDay = new Date(nextReview.date); reviewDay.setHours(0,0,0,0);
                const diffTime = reviewDay - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (isToday(nextReview.date)) {
                    statusText = `Ôn tập hôm nay! (Lần ${nextReview.index + 1})`;
                    statusColor = 'text-red-600';
                    borderColor = 'border-red-500';
                } else if (isPast(nextReview.date)) {
                    statusText = `Trễ hạn! (Lần ${nextReview.index + 1})`;
                    statusColor = 'text-amber-600';
                    borderColor = 'border-amber-500';
                } else {
                    statusText = `Còn ${diffDays} ngày - ${formatDate(nextReview.date)}`;
                    statusColor = 'text-sky-600';
                    borderColor = 'border-sky-500';
                }
            } else {
                statusText = 'Đã hoàn thành tất cả!';
                statusColor = 'text-emerald-600';
                borderColor = 'border-emerald-500';
            }
            card.classList.add(borderColor);
            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="font-bold text-lg mb-2 text-slate-800">${task.name}</h3>
                    <p class="text-sm text-slate-500 mb-3">Bắt đầu: ${formatDate(new Date(task.startDate + 'T00:00:00'))}</p>
                    <div class="font-semibold ${statusColor} text-sm mb-4">${statusText}</div>
                    <div class="text-xs text-slate-600 mb-1">Tiến độ: ${reviewsCompleted}/${totalReviews} lần</div>
                    <div class="h-2.5 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div class="progress-bar-inner bg-gradient-to-r ${progressPercent === 100 ? 'from-emerald-400 to-green-500' : 'from-sky-400 to-indigo-500'}" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end gap-2">
                    <button class="edit-btn p-2 text-slate-400 hover:text-indigo-600 transition-colors rounded-full hover:bg-indigo-50"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button class="delete-btn p-2 text-slate-400 hover:text-red-600 transition-colors rounded-full hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `;
            card.addEventListener('click', () => renderSingleTaskTimeline(task));
            card.querySelector('.delete-btn')?.addEventListener('click', e => { e.stopPropagation(); showCustomConfirm({ title: 'Xác nhận xóa', message: `Bạn có chắc chắn muốn xóa chủ đề "${task.name}"?`, okText: "Xóa", onOk: () => deleteTask(task.id) }); });
            card.querySelector('.edit-btn')?.addEventListener('click', e => { e.stopPropagation(); openModal(task); });
            return card;
        }

        function openModal(task = null) {
            ui.taskForm.reset();
            if (task) {
                ui.modalTitle.textContent = 'Chỉnh Sửa Chủ Đề';
                ui.taskIdInput.value = task.id;
                ui.taskNameInput.value = task.name;
                ui.startDateInput.value = task.startDate;
            } else {
                ui.modalTitle.textContent = 'Thêm Chủ Đề Mới';
                ui.taskIdInput.value = '';
                ui.startDateInput.value = new Date().toISOString().split('T')[0];
            }
            ui.taskModal.classList.remove('hidden');
            setTimeout(() => {
                ui.taskModal.classList.remove('opacity-0');
                ui.modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            ui.taskModal.classList.add('opacity-0');
            ui.modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => ui.taskModal.classList.add('hidden'), 300);
        }

        async function saveTask(e) {
            e.preventDefault();
            const id = ui.taskIdInput.value;
            const name = ui.taskNameInput.value.trim();
            const startDate = ui.startDateInput.value;
            if (!name || !startDate) return showToast("Vui lòng điền đầy đủ thông tin.");
            try {
                const taskData = { name, startDate };
                if (id) {
                    await updateDoc(doc(db, topicsCollectionRef.path, id), taskData);
                    showToast('Cập nhật chủ đề thành công!');
                } else {
                    await addDoc(topicsCollectionRef, { ...taskData, reviewsCompleted: 0, ownerId: userId });
                    showToast('Thêm chủ đề mới thành công!');
                }
                closeModal();
            } catch (error) { console.error("Error saving task: ", error); showToast(`Lỗi: ${error.message}`); }
        }

        async function deleteTask(id) {
            try {
                await deleteDoc(doc(db, topicsCollectionRef.path, id));
                showToast('Đã xóa chủ đề.');
            } catch (error) { console.error("Error deleting task: ", error); showToast(`Lỗi khi xóa: ${error.message}`); }
        }
        
        async function setReviewsCompleted(taskId, count) {
            try {
                await updateDoc(doc(db, topicsCollectionRef.path, taskId), { reviewsCompleted: count });
                showToast(count > 0 ? `Đã cập nhật tiến độ!` : 'Đã hoàn tác!');
                
                // Refresh single task timeline if it's open
                const singleTimelineModal = ui.singleTaskTimelineModal.backdrop;
                if (!singleTimelineModal.classList.contains('hidden') && singleTimelineModal.dataset.taskId === taskId) {
                    const task = localTopicsCache.find(t => t.id === taskId);
                    if(task) {
                        task.reviewsCompleted = count; // Update local cache immediately for instant UI feedback
                        renderSingleTaskTimeline(task);
                    }
                }
            } catch (error) {
                console.error("Error updating review status: ", error);
                showToast(`Lỗi: ${error.message}`);
            }
        }

        function renderTimeline() {
            const eventsByDate = {};
            localTopicsCache.forEach(task => {
                getReviewSchedule(task.startDate).forEach((date, index) => {
                    const dateString = date.toISOString().split('T')[0];
                    if (!eventsByDate[dateString]) eventsByDate[dateString] = [];
                    eventsByDate[dateString].push({ 
                        id: task.id,
                        name: task.name, 
                        reviewIndex: index,
                        completed: (task.reviewsCompleted || 0) > index 
                    });
                });
            });
            const sortedDates = Object.keys(eventsByDate).sort();
            const container = ui.timelineModal.container;
            container.innerHTML = '';
            if (sortedDates.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 w-full mt-8">Không có sự kiện nào trong lịch trình.</p>';
            } else {
                sortedDates.forEach(dateString => {
                    const date = new Date(dateString + 'T00:00:00');
                    const isCurrentDay = isToday(date);
                    const column = document.createElement('div');
                    column.className = `timeline-day-column p-3 rounded-lg border-2 ${isCurrentDay ? 'border-indigo-500 bg-indigo-50' : 'bg-slate-100 border-slate-200'}`;
                    column.dataset.date = dateString;
                    const itemsHtml = eventsByDate[dateString].map(item => `
                        <div class="flex items-start text-sm p-2 rounded-md ${item.completed ? 'bg-slate-200 text-slate-500' : 'bg-white shadow-sm text-slate-700'}">
                            <input type="checkbox" id="timeline-check-${item.id}-${item.reviewIndex}" class="timeline-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3 mt-0.5 flex-shrink-0" 
                                data-task-id="${item.id}" 
                                data-task-name="${item.name}"
                                data-review-index="${item.reviewIndex}"
                                ${item.completed ? 'checked' : ''}>
                            <label for="timeline-check-${item.id}-${item.reviewIndex}" class="cursor-pointer">${item.name}</label>
                        </div>
                    `).join('');
                    column.innerHTML = `<div class="text-center mb-3"><p class="font-bold ${isCurrentDay ? 'text-indigo-600' : 'text-slate-800'}">${formatDayOfWeek(date)}</p><p class="text-xs text-slate-500">${date.getDate()}/${date.getMonth() + 1}</p></div><div class="space-y-2">${itemsHtml}</div>`;
                    container.appendChild(column);
                });
            }
            lucide.createIcons();
            ui.timelineModal.backdrop.classList.remove('hidden');
            setTimeout(() => {
                ui.timelineModal.backdrop.classList.remove('opacity-0');
                ui.timelineModal.content.classList.remove('scale-95', 'opacity-0');
                const todayColumn = container.querySelector(`[data-date="${new Date().toISOString().split('T')[0]}"]`);
                if (todayColumn) todayColumn.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }, 10);
        }

        function closeTimelineModal() {
            ui.timelineModal.backdrop.classList.add('opacity-0');
            ui.timelineModal.content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => ui.timelineModal.backdrop.classList.add('hidden'), 300);
        }

        function renderSingleTaskTimeline(task) {
            const modal = ui.singleTaskTimelineModal;
            modal.backdrop.dataset.taskId = task.id;
            modal.title.textContent = task.name;
            const container = modal.container;
            container.innerHTML = '';

            const schedule = getReviewSchedule(task.startDate);
            const reviewsCompleted = task.reviewsCompleted || 0;

            schedule.forEach((date, index) => {
                const step = document.createElement('div');
                const isCompleted = index < reviewsCompleted;
                const isNext = index === reviewsCompleted;
                
                let statusClass = 'bg-white';
                let icon = `<i data-lucide="circle" class="w-5 h-5 text-slate-300"></i>`;
                let buttonHtml = '';

                if (isCompleted) {
                    statusClass = 'bg-green-100 border-green-500';
                    icon = `<i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>`;
                    buttonHtml = `<button disabled class="text-sm px-3 py-1 rounded-md bg-slate-200 text-slate-500 cursor-not-allowed">Đã hoàn thành</button>`;
                } else if (isNext) {
                    statusClass = 'bg-sky-100 border-sky-500 shadow-md';
                    icon = `<i data-lucide="play-circle" class="w-5 h-5 text-sky-500"></i>`;
                    buttonHtml = `<button data-review-index="${index}" class="complete-review-btn text-sm font-semibold px-3 py-1 rounded-md bg-green-500 text-white hover:bg-green-600 transition">Đã ôn xong</button>`;
                } else { // Future
                     statusClass = 'bg-white';
                     icon = `<i data-lucide="clock" class="w-5 h-5 text-slate-400"></i>`;
                     buttonHtml = `<button data-review-index="${index}" class="complete-review-btn text-sm font-semibold px-3 py-1 rounded-md bg-slate-600 text-white hover:bg-slate-700 transition">Hoàn thành sớm</button>`;
                }

                step.className = `relative pl-10 pr-4 py-3 rounded-lg border ${statusClass}`;
                step.innerHTML = `
                    <div class="absolute left-3 top-4">${icon}</div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-slate-700">Lần ôn tập ${index + 1}</p>
                            <p class="text-sm text-slate-500">${formatDayOfWeek(date)}, ${formatDate(date)}</p>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
                container.appendChild(step);
            });
            
            lucide.createIcons();
            
            container.querySelectorAll('.complete-review-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const reviewIndex = parseInt(btn.dataset.reviewIndex);
                    setReviewsCompleted(task.id, reviewIndex + 1);
                });
            });

            modal.backdrop.classList.remove('hidden');
            setTimeout(() => {
                modal.backdrop.classList.remove('opacity-0');
                modal.content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeSingleTaskTimelineModal() {
            const modal = ui.singleTaskTimelineModal;
            modal.backdrop.classList.add('opacity-0');
            modal.content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.backdrop.classList.add('hidden'), 300);
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Lỗi khi đăng nhập với Google:", error);
                showToast("Đăng nhập thất bại. Vui lòng thử lại.");
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Lỗi khi đăng xuất:", error);
                showToast("Đăng xuất thất bại.");
            }
        }

        function setupEventListeners() {
            ui.loginBtn.addEventListener('click', signInWithGoogle);
            ui.logoutBtn.addEventListener('click', signOutUser);
            ui.addTaskBtn.addEventListener('click', () => openModal());
            ui.cancelBtn.addEventListener('click', closeModal);
            ui.taskModal.addEventListener('click', e => e.target === ui.taskModal && closeModal());
            ui.taskForm.addEventListener('submit', saveTask);
            
            // Timeline listeners
            ui.timelineBtn.addEventListener('click', renderTimeline);
            ui.timelineModal.closeBtn.addEventListener('click', closeTimelineModal);
            ui.timelineModal.backdrop.addEventListener('click', e => e.target === ui.timelineModal.backdrop && closeTimelineModal());
            ui.timelineModal.prevBtn.addEventListener('click', () => { ui.timelineModal.wrapper.scrollBy(-300, 0); });
            ui.timelineModal.nextBtn.addEventListener('click', () => { ui.timelineModal.wrapper.scrollBy(300, 0); });
            ui.timelineModal.container.addEventListener('change', e => {
                if(e.target.classList.contains('timeline-checkbox')) {
                    const checkbox = e.target;
                    const { taskId, taskName, reviewIndex } = checkbox.dataset;
                    const newIndex = parseInt(reviewIndex);
                    
                    if (checkbox.checked) {
                        setReviewsCompleted(taskId, newIndex + 1);
                    } else {
                        showCustomConfirm({
                            title: 'Xác nhận hoàn tác',
                            message: `Bạn có muốn hoàn tác lần ôn tập này cho chủ đề "${taskName}" không?`,
                            okText: 'Hoàn tác',
                            onOk: () => setReviewsCompleted(taskId, newIndex)
                        });
                        // Prevent UI from changing until confirmed
                        checkbox.checked = true; 
                    }
                }
            });

            // Single Task Timeline Listeners
            ui.singleTaskTimelineModal.closeBtn.addEventListener('click', closeSingleTaskTimelineModal);
            ui.singleTaskTimelineModal.backdrop.addEventListener('click', e => e.target === ui.singleTaskTimelineModal.backdrop && closeSingleTaskTimelineModal());

            // Filter buttons
            ui.filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    ui.filterBtns.forEach(b => {
                        b.classList.remove('text-indigo-600', 'border-indigo-600');
                        b.classList.add('text-slate-500');
                    });
                    btn.classList.add('text-indigo-600', 'border-indigo-600');
                    btn.classList.remove('text-slate-500');
                    renderTasks(btn.dataset.filter);
                });
            });
        }

        async function main() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza...")) {
                document.body.innerHTML = '<div class="text-center p-8 text-red-500 font-bold">Lỗi: Vui lòng cung cấp thông tin cấu hình Firebase hợp lệ trong tệp HTML.</div>';
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.body.innerHTML = '<div class="text-center p-8 text-red-500 font-bold">Không thể kết nối tới cơ sở dữ liệu. Vui lòng kiểm tra lại thông tin cấu hình.</div>';
                return;
            }

            setupEventListeners();
            lucide.createIcons();

            onAuthStateChanged(auth, user => {
                if (user) { // User is signed in
                    ui.loginContainer.classList.add('hidden');
                    ui.appContainer.classList.remove('hidden');
                    
                    userId = user.uid;
                    ui.userInfo.name.textContent = user.displayName;
                    ui.userInfo.email.textContent = user.email;
                    ui.userInfo.avatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;
                    
                    const userTopicsPath = `artifacts/${appId}/users/${userId}/topics`;
                    topicsCollectionRef = collection(db, userTopicsPath);
                    
                    if (unsubscribe) unsubscribe(); 
                    
                    unsubscribe = onSnapshot(query(topicsCollectionRef), (snapshot) => {
                        localTopicsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const currentFilter = document.querySelector('.filter-btn.text-indigo-600').dataset.filter;
                        renderTasks(currentFilter);
                    }, (error) => {
                        console.error("Firestore snapshot error:", error);
                        ui.loadingState.innerText = "Lỗi khi tải dữ liệu. Kiểm tra console (F12) để biết chi tiết.";
                    });

                } else { // User is signed out
                    ui.appContainer.classList.add('hidden');
                    ui.loginContainer.classList.remove('hidden');
                    if (unsubscribe) unsubscribe();
                    localTopicsCache = [];
                    ui.taskList.innerHTML = '';
                    ui.emptyState.classList.add('hidden');
                    ui.loadingState.classList.remove('hidden');
                }
            });
        }

        main();
    </script>
    
</body>
</html>
